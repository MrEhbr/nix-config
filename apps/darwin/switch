#!/bin/sh -e

GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
NC='\033[0m'

# Accept configuration as argument
CONFIG="$1"

if [ -z "$CONFIG" ]; then
    echo "${RED}Usage: nix run .#switch <config> [nix-args...]${NC}"
    AVAILABLE=$(nix --extra-experimental-features 'nix-command flakes' eval --json .#darwinConfigurations --apply builtins.attrNames | jq -r '.[]' | tr '\n' ', ' | sed 's/,$//')
    echo "${YELLOW}Available configs: $AVAILABLE${NC}"
    exit 1
fi

# Validate configuration exists
if ! nix --extra-experimental-features 'nix-command flakes' eval .#darwinConfigurations.$CONFIG >/dev/null 2>&1; then
    echo "${RED}Configuration '$CONFIG' not found${NC}"
    AVAILABLE=$(nix --extra-experimental-features 'nix-command flakes' eval --json .#darwinConfigurations --apply builtins.attrNames | jq -r '.[]' | tr '\n' ', ' | sed 's/,$//')
    echo "${YELLOW}Available configs: $AVAILABLE${NC}"
    exit 1
fi

echo "${GREEN}Using configuration: $CONFIG${NC}"

# Shift to pass remaining args to nix
shift

echo "${YELLOW}Switching to $CONFIG...${NC}"
sudo darwin-rebuild switch --flake .#$CONFIG "$@"

echo "${GREEN}Switch complete!${NC}"

