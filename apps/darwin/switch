#!/bin/sh -e

GREEN='\033[1;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
NC='\033[0m'

# Get configuration from lockfile
CONFIG_LOCK="$HOME/.nix-darwin-config-lock"

if [ ! -f "$CONFIG_LOCK" ]; then
    echo "${RED}No configuration lock found. Run build-switch first.${NC}"
    exit 1
fi

CONFIG=$(cat "$CONFIG_LOCK")
echo "${GREEN}Using locked configuration: $CONFIG${NC}"

# All arguments are passed to nix (no config argument to shift)

echo "${YELLOW}Switching to $CONFIG...${NC}"
sudo darwin-rebuild switch --flake .#$CONFIG "$@"

echo "${GREEN}Switch complete!${NC}"
